<header class="header">
  <div class="header-container">
    <!-- Top Row -->
    <div class="header-top">
      <!-- COMMENTED OUT: Sidebar toggle buttons in header - using edge toggle arrows instead -->
      <!-- Can be re-enabled later if needed -->
      <!-- Sidebar Toggle Button - Left (furthest left) -->
      <!--
      <button class="sidebar-toggle sidebar-toggle-left" aria-label="Toggle Left Menu" id="sidebar-toggle-left"
        title="Open Left Sidebar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
      </button>
      -->

      <!-- Logo Section with integrated dropdown -->
      <div class="header-logo">
        {{ partial "logo.html" . }}
        <!-- Controls Dropdown attached to logo -->
        <div id="controlsDropdown" class="controls-dropdown">
          <div class="header__btn-group">
            <!-- RSS Feeds -->
            <div class="rss-feeds" style="position:relative;">
              <button id="rssToggle" class="header__random-btn" type="button" aria-label="RSS Feeds" title="RSS Feeds"
                style="display:flex;align-items:center;justify-content:left;padding:4px 6px;gap:4px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" role="img">
                  <path d="M6.18 17.82a2.18 2.18 0 1 1-4.36 0 2.18 2.18 0 0 1 4.36 0Z" />
                  <path d="M2 10.59v3.05c4.13 0 7.49 3.36 7.49 7.49h3.05c0-5.82-4.72-10.54-10.54-10.54Z" />
                  <path d="M2 4v3.05c7.57 0 13.69 6.12 13.69 13.69h3.05C18.74 11.33 11.41 4 2 4Z" />
                </svg>
                <svg width="10" height="10" viewBox="0 0 12 8" fill="none" aria-hidden="true" class="rss-caret">
                  <path d="M2 2l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
              </button>
              <div id="rssMenu" class="rss-menu"
                style="display:none; position:absolute; top:48px; right:0; background:rgba(0,0,0,0.9); border:1px solid #ff6b35; padding:10px 12px; border-radius:8px; min-width:220px; z-index:999; box-shadow:0 4px 18px rgba(0,0,0,0.4); text-align:left;">
                <div
                  style="font-size:0.8rem; letter-spacing:0.05em; text-transform:uppercase; opacity:0.7; margin-bottom:6px;">
                  RSS Feeds</div>
                <a class="rss-link" href="/artifacts/index.xml">4n6Post Artifact Feed</a>
                <a class="rss-link" href="/writeups/index.xml">CTF Writeups Feed</a>
                <a class="rss-link" href="/dockers/index.xml">Dockers Feed üêã</a>
              </div>
            </div>
            <button id="randomColorBtn" class="header__random-btn" type="button" aria-label="Randomize link color"
              title="Randomize link color">üé≤</button>
            <button id="randomPostColorBtn" class="header__random-btn" type="button"
              aria-label="Randomize post font color" title="Randomize post font color">üñçÔ∏è</button>
            <button id="resetColorBtn" class="header__random-btn" type="button" aria-label="Reset colors"
              title="Reset colors">üîÑ</button>
            <a href="https://github.com/jonesckevin/" target="_blank" rel="noopener" aria-label="GitHub Repository"
              class="header-github-link">
              <svg height="28" width="28" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                <path
                  d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z">
                </path>
              </svg></a>
            <span class="theme-toggle not-selectable">{{ partial "theme-toggle-icon.html" . }}</span>
          </div>
        </div>
      </div>

      <!-- Center Navigation -->
      <div class="header-center">
        <nav class="header-main-nav">
          {{- if .Site.Menus.main }}
          <div class="main-nav-desktop">
            {{- range .Site.Menus.main }}
            {{- $current := or ($.IsMenuCurrent "main" .) ($.HasMenuCurrent "main" .) }}
            <a href="{{ .URL | relLangURL }}" class="nav-item" {{- if $current }} aria-current="page" {{- end }}>
              {{ .Name }}
            </a>
            {{- end }}
          </div>
          <button class="main-nav-mobile-toggle" id="mainNavToggle" aria-label="Main Navigation">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
          </button>
          <div class="main-nav-mobile-dropdown" id="mainNavDropdown">
            {{- range .Site.Menus.main }}
            {{- $current := or ($.IsMenuCurrent "main" .) ($.HasMenuCurrent "main" .) }}
            <a href="{{ .URL | relLangURL }}" class="mobile-nav-item" {{- if $current }} aria-current="page" {{- end }}>
              {{ .Name }}
            </a>
            {{- end }}
          </div>
          {{- end }}
        </nav>
      </div>

      <!-- Right Section -->
      <div class="header-right">

        <!-- AI Provider Configuration -->
        <div class="ai-profile">
          <button class="ai-profile-btn" aria-label="AI Settings">
            <svg class="ai-cog" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="1.5">
              <circle cx="12" cy="12" r="5.5" />
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z" />
            </svg>
            <span class="ai-badge">AI</span>
          </button>
          <div class="ai-dropdown">
            <div class="ai-dropdown-inner">
              <div class="ai-dropdown-header">
                AI Provider Settings
                <button class="ai-help-btn" id="ai-help-toggle" aria-label="Show AI Tools Help"
                  title="How to use AI Tools">‚ùì</button>
              </div>
              <div class="ai-dropdown-content">
                <!-- Top Row: GIF and Settings side-by-side -->
                <div class="ai-top-row">
                  <!-- Help Section (Left on wide screens) - GIF only -->
                  <div class="ai-help-section" id="ai-help-section" style="display: none;">
                    <div class="ai-help-content">
                      <h4>How to Use AI Tools</h4>
                      <img src="/images/help/ai-tool-help.gif" alt="AI Tools Tutorial" class="ai-help-gif">
                    </div>
                  </div>
                  <!-- Settings Section (Right on wide screens) -->
                  <div class="ai-settings-section">
                    <div class="ai-field">
                      <label for="ai-provider">Provider</label>
                      <select id="ai-provider">
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="grok">Grok (X.AI)</option>
                      </select>
                    </div>
                    <div class="ai-field">
                      <label for="ai-key">API Key</label>
                      <input type="password" id="ai-key" placeholder="Enter your API key">
                      <small class="ai-help">Keys are stored only for your session</small>
                    </div>
                    <div class="ai-field">
                      <label for="ai-model">Model (Optional)</label>
                      <select id="ai-model" disabled>
                        <option value="">Enter API key to load models...</option>
                      </select>
                      <small id="ai-model-help" class="ai-help">Models are fetched from the selected provider after
                        validating your API key.</small>
                      <button class="ai-help-btn ai-tools-flashy-btn" onclick="window.location.href='/ai-tools/'"
                        aria-label="Browse AI Tools" title="Browse AI Tools" style="font-size: 14px!important; margin-top: 12px; width: 100%; min-width: auto!important; padding: 10px 12px; white-space: nowrap; 
                            background: linear-gradient(135deg, #ff8c69 0%, #008500 50%, #b38300 100%) !important;
                            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4), inset 0 -3px 8px rgba(0, 0, 0, 0.2), inset 0 3px 8px rgba(255, 255, 255, 0.3) !important;
                            border: 2px solid #ff6b35 !important;
                            transform: translateY(-2px);
                            animation: pulse-glow 2s ease-in-out infinite;
                            font-weight: bold !important;
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                              cursor: pointer;">Browse AI Tools</button>
                    </div>
                  </div>
                </div>
                <!-- Bottom Row: Instructions spanning full width -->
                <div class="ai-instructions-row" id="ai-instructions-row" style="display: none;">
                  <ul class="ai-help-list">
                    <li>Configure your AI provider by selecting one from the dropdown. <a href="#" id="provider-link"
                        target="_blank" rel="noopener noreferrer">Visit provider website</a></li>
                    <li>Enter your API key. <span id="key-format">Format: <code>sk-...</code></span></li>
                    <li>Optionally choose a specific model. <a href="#" id="pricing-link" target="_blank"
                        rel="noopener noreferrer">View pricing</a></li>
                    <li>Visit any AI tool page to start using powerful AI-driven features like story generators, quiz
                      creators, and more.</li>
                    <li>Your API key is stored securely in your browser session and never sent to our servers.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- COMMENTED OUT: Sidebar toggle buttons in header - using edge toggle arrows instead -->
        <!-- Can be re-enabled later if needed -->
        <!-- Sidebar Toggle Button - Left (furthest left) -->
        <!-- Sidebar Toggle Button - Right -->
        <!--
        <button class="sidebar-toggle sidebar-toggle-right" aria-label="Toggle Right Menu" id="sidebar-toggle-right"
          title="Open Right Sidebar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="15" y1="3" x2="15" y2="21"></line>
          </svg>
        </button>
        -->
      </div>
    </div>
  </div>
</header>

100% {
background-position: 0% 50%;
}
}
</style>
<script>
  // Persistent color management
  function getStoredColor(key) {
    return localStorage.getItem(key);
  }

  function setStoredColor(key, color) {
    localStorage.setItem(key, color);
  }

  function removeStoredColor(key) {
    localStorage.removeItem(key);
  }

  function applyStoredColors() {
    // Apply stored link color
    const linkColor = getStoredColor('randomLinkColor');
    if (linkColor) {
      document.querySelectorAll('a').forEach(function (link) {
        link.style.color = linkColor;
      });
    }

    // Apply stored paragraph color
    const paragraphColor = getStoredColor('randomParagraphColor');
    if (paragraphColor) {
      document.querySelectorAll('p').forEach(function (paragraph) {
        paragraph.style.color = paragraphColor;
      });
    }
  }

  // Change all <a> link font colors to a random color when the button is clicked
  document.addEventListener('DOMContentLoaded', function () {
    // Apply stored colors on page load
    applyStoredColors();

    var btn = document.getElementById('randomColorBtn');
    if (btn) {
      btn.addEventListener('click', function () {
        var randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
        setStoredColor('randomLinkColor', randomColor);
        document.querySelectorAll('a').forEach(function (link) {
          link.style.color = randomColor;
        });
        // Also apply color to the toggle control character
        var toggleControl = document.getElementById('controlsToggle');
        if (toggleControl) {
          toggleControl.style.color = randomColor;
        }
      });
    }

    // Change paragraph font color when the second button is clicked
    var postBtn = document.getElementById('randomPostColorBtn');
    if (postBtn) {
      postBtn.addEventListener('click', function () {
        var randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
        setStoredColor('randomParagraphColor', randomColor);
        document.querySelectorAll('p').forEach(function (paragraph) {
          paragraph.style.color = randomColor;
        });
      });
    }

    // Reset colors when the reset button is clicked
    var resetBtn = document.getElementById('resetColorBtn');
    if (resetBtn) {
      resetBtn.addEventListener('click', function () {
        // Remove stored colors
        removeStoredColor('randomLinkColor');
        removeStoredColor('randomParagraphColor');

        // Reset actual colors
        document.querySelectorAll('a').forEach(function (link) {
          link.style.color = '';
        });
        document.querySelectorAll('p').forEach(function (paragraph) {
          paragraph.style.color = '';
        });
        // Also reset the toggle control character color
        var toggleControl = document.getElementById('controlsToggle');
        if (toggleControl) {
          toggleControl.style.color = '';
        }
      });
    }

    // Function to apply colors to newly loaded content
    window.applyPersistentColors = function (container) {
      const linkColor = getStoredColor('randomLinkColor');
      const paragraphColor = getStoredColor('randomParagraphColor');

      if (linkColor) {
        const links = container ? container.querySelectorAll('a') : document.querySelectorAll('a');
        links.forEach(function (link) {
          link.style.color = linkColor;
        });
        // Also apply stored color to the toggle control character
        var toggleControl = document.getElementById('controlsToggle');
        if (toggleControl) {
          toggleControl.style.color = linkColor;
        }
      }

      if (paragraphColor) {
        const paragraphs = container ? container.querySelectorAll('p') : document.querySelectorAll('p');
        paragraphs.forEach(function (paragraph) {
          paragraph.style.color = paragraphColor;
        });
      }
    };

    // Observe for dynamically added content
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
          mutation.addedNodes.forEach(function (node) {
            if (node.nodeType === Node.ELEMENT_NODE) {
              // Apply colors to the newly added element and its children
              window.applyPersistentColors(node);
            }
          });
        }
      });
    });

    // Start observing changes to the document
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // AI Configuration Management
    const aiProfileBtn = document.querySelector('.ai-profile-btn');
    const aiDropdown = document.querySelector('.ai-dropdown');

    // AI Profile dropdown management
    if (aiProfileBtn && aiDropdown) {
      aiProfileBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        aiDropdown.classList.toggle('open');
      });

      // Close dropdown when clicking outside (but not on AI elements)
      document.addEventListener('click', function (e) {
        if (aiDropdown.classList.contains('open')) {
          const isClickInsideDropdown = aiDropdown.contains(e.target);
          const isClickOnButton = aiProfileBtn.contains(e.target);

          if (!isClickInsideDropdown && !isClickOnButton) {
            aiDropdown.classList.remove('open');
          }
        }
      });

      // Prevent dropdown from closing when clicking inside it
      aiDropdown.addEventListener('click', function (e) {
        e.stopPropagation();
      });
    }

    // AI Help Toggle
    const aiHelpToggle = document.getElementById('ai-help-toggle');
    const aiHelpSection = document.getElementById('ai-help-section');
    const aiInstructionsRow = document.getElementById('ai-instructions-row');

    if (aiHelpToggle && aiHelpSection) {
      aiHelpToggle.addEventListener('click', function (e) {
        e.stopPropagation();
        if (aiHelpSection.style.display === 'none' || aiHelpSection.style.display === '') {
          aiHelpSection.style.display = 'block';
          if (aiInstructionsRow) aiInstructionsRow.style.display = 'block';
          aiHelpToggle.setAttribute('aria-label', 'Hide AI Tools Help');
        } else {
          aiHelpSection.style.display = 'none';
          if (aiInstructionsRow) aiInstructionsRow.style.display = 'none';
          aiHelpToggle.setAttribute('aria-label', 'Show AI Tools Help');
        }
      });
    }

    // AI Provider settings management
    const aiProvider = document.getElementById('ai-provider');
    const aiKey = document.getElementById('ai-key');
    const aiModel = document.getElementById('ai-model');
    const aiModelHelp = document.getElementById('ai-model-help');
    // Retry counters for deferred loading of apiManager (after header merge)
    let apiManagerRetryCount = 0;
    const MAX_API_MANAGER_RETRIES = 25; // ~7.5s at 300ms interval

    // Update API key placeholder based on provider
    function updateApiKeyPlaceholder(provider) {
      if (!aiKey) return;
      const placeholders = {
        openai: 'Enter your OpenAI API key (sk-...)',
        deepseek: 'Enter your DeepSeek API key (sk-...)',
        anthropic: 'Enter your Anthropic API key (sk-ant-...)',
        gemini: 'Enter your Gemini API key (AIza...)',
        grok: 'Enter your Grok API key (xai-...)'
      };
      aiKey.placeholder = placeholders[provider] || 'Enter your API key';
    }

    // Update provider-specific links in instructions
    function updateProviderLinks(provider) {
      const providerLink = document.getElementById('provider-link');
      const keyFormat = document.getElementById('key-format');
      const pricingLink = document.getElementById('pricing-link');

      const providerInfo = {
        openai: {
          url: 'https://platform.openai.com/api-keys',
          name: 'OpenAI API website',
          keyFormat: 'sk-...',
          pricing: 'https://openai.com/api/pricing/'
        },
        deepseek: {
          url: 'https://platform.deepseek.com/api_keys',
          name: 'DeepSeek API website',
          keyFormat: 'sk-...',
          pricing: 'https://platform.deepseek.com/api-docs/pricing'
        },
        anthropic: {
          url: 'https://console.anthropic.com/settings/keys',
          name: 'Anthropic API website',
          keyFormat: 'sk-ant-...',
          pricing: 'https://www.anthropic.com/pricing'
        },
        gemini: {
          url: 'https://aistudio.google.com/app/apikey',
          name: 'Google AI Studio',
          keyFormat: 'AIza...',
          pricing: 'https://ai.google.dev/pricing'
        },
        grok: {
          url: 'https://console.x.ai/',
          name: 'Grok (X.AI) Console',
          keyFormat: 'xai-...',
          pricing: 'https://x.ai/api'
        }
      };

      const info = providerInfo[provider] || providerInfo.openai;

      if (providerLink) {
        providerLink.href = info.url;
        providerLink.textContent = info.name;
      }

      if (keyFormat) {
        keyFormat.innerHTML = `Format: <code>${info.keyFormat}</code>`;
      }

      if (pricingLink) {
        pricingLink.href = info.pricing;
      }
    }

    // Reset model select to default state
    function resetModelSelect() {
      if (!aiModel) return;
      aiModel.innerHTML = '<option value="">Enter API key to load models...</option>';
      aiModel.disabled = true;
      if (aiModelHelp) aiModelHelp.textContent = 'Models are fetched from the selected provider after validating your API key.';
    }

    // Load models from API provider
    async function tryLoadModels() {
      // Wait for apiManager & utils to be available (they may load after header now)
      if (!window.apiManager || !window.utils || !aiProvider || !aiKey || !aiModel) {
        if (apiManagerRetryCount < MAX_API_MANAGER_RETRIES) {
          apiManagerRetryCount++;
          if (aiModelHelp) aiModelHelp.textContent = 'Waiting for AI engine...';
          // Keep select disabled while waiting (avoid premature fallback)
          if (aiModel) {
            aiModel.disabled = true;
          }
          setTimeout(tryLoadModels, 300);
        } else {
          // After retries, show explicit error (no fallback models)
          if (aiModel) {
            aiModel.innerHTML = '<option value="">(Unavailable)</option>';
            aiModel.disabled = true;
          }
          if (aiModelHelp) aiModelHelp.textContent = 'AI engine not ready. Models could not be loaded.';
        }
        return;
      }

      // apiManager is ready - reset retry counter
      apiManagerRetryCount = 0;

      const provider = aiProvider.value;
      const key = (aiKey.value || '').trim();

      if (!provider || !window.utils.validateApiKey(key, provider)) {
        resetModelSelect();
        return;
      }

      try {
        if (aiModelHelp) aiModelHelp.textContent = 'Loading models from provider...';
        if (aiModel.parentElement) aiModel.parentElement.classList.add('loading');

        const models = await window.apiManager.listModels(provider, key);

        if (!Array.isArray(models) || models.length === 0) {
          if (aiModelHelp) aiModelHelp.textContent = 'No chat models available for this key/provider.';
          return;
        }

        // Render models with category headers as optgroups and bullet points
        let html = '';
        let currentCategory = null;

        models.forEach(m => {
          if (m.isHeader) {
            // Close previous optgroup if exists
            if (currentCategory !== null) {
              html += '</optgroup>';
            }
            // Start new optgroup for category
            html += `<optgroup label="${m.label}">`;
            currentCategory = m.category;
          } else {
            // Regular model option - simple indentation without visual marker
            const prefix = '    '; // 4 spaces for clean indentation
            html += `<option value="${m.id}">${prefix}${m.label}</option>`;
          }
        });

        // Close last optgroup if exists
        if (currentCategory !== null) {
          html += '</optgroup>';
        }

        aiModel.innerHTML = html;
        aiModel.disabled = false;

        // Select previously saved model or provider default
        const desired = window.apiManager.getModel(provider) || window.apiManager.getProviderConfig(provider).defaultModel;
        const found = Array.from(aiModel.options).some(opt => opt.value === desired);
        aiModel.value = found ? desired : aiModel.options[0].value;

        window.apiManager.setModel(aiModel.value, provider);
        if (aiModelHelp) aiModelHelp.textContent = 'Models loaded.';

      } catch (err) {
        console.error('Failed to load models:', err);
        if (aiModel) {
          aiModel.innerHTML = '<option value="">(Error loading models)</option>';
          aiModel.disabled = true;
        }
        if (aiModelHelp) aiModelHelp.textContent = (err && err.message ? err.message : 'Failed to load models from provider.');
      } finally {
        if (aiModel.parentElement) aiModel.parentElement.classList.remove('loading');
      }
    }

    // Removed static fallback list per requirement; we now present explicit error states only.

    // Controls dropdown toggle logic using logo mark
    const controlsToggle = document.getElementById('controlsToggle');
    const controlsDropdown = document.getElementById('controlsDropdown');
    if (controlsToggle && controlsDropdown) {
      controlsToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isShowing = controlsDropdown.classList.contains('show');
        controlsDropdown.classList.toggle('show');
        controlsToggle.classList.toggle('active', !isShowing);
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (controlsDropdown.classList.contains('show') &&
          !controlsDropdown.contains(e.target) &&
          e.target !== controlsToggle) {
          controlsDropdown.classList.remove('show');
          controlsToggle.classList.remove('active');
        }
      });

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && controlsDropdown.classList.contains('show')) {
          controlsDropdown.classList.remove('show');
          controlsToggle.classList.remove('active');
        }
      });

      // Prevent dropdown from closing when clicking inside it
      controlsDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    // Main navigation mobile toggle
    const mainNavToggle = document.getElementById('mainNavToggle');
    const mainNavDropdown = document.getElementById('mainNavDropdown');
    if (mainNavToggle && mainNavDropdown) {
      mainNavToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isShowing = mainNavDropdown.classList.contains('show');
        mainNavDropdown.classList.toggle('show');
        mainNavToggle.classList.toggle('active', !isShowing);
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (mainNavDropdown.classList.contains('show') &&
          !mainNavDropdown.contains(e.target) &&
          e.target !== mainNavToggle) {
          mainNavDropdown.classList.remove('show');
          mainNavToggle.classList.remove('active');
        }
      });

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mainNavDropdown.classList.contains('show')) {
          mainNavDropdown.classList.remove('show');
          mainNavToggle.classList.remove('active');
        }
      });

      // Prevent dropdown from closing when clicking inside it
      mainNavDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }    // RSS toggle logic
    const rssToggle = document.getElementById('rssToggle');
    const rssMenu = document.getElementById('rssMenu');
    if (rssToggle && rssMenu) {
      rssToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = rssMenu.style.display === 'block';
        rssMenu.style.display = open ? 'none' : 'block';
      });
      document.addEventListener('click', (e) => {
        if (rssMenu.style.display === 'block' && !rssMenu.contains(e.target) && e.target !== rssToggle) {
          rssMenu.style.display = 'none';
        }
      });
      // Close on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') rssMenu.style.display = 'none';
      });
    }

    // Load saved settings
    if (aiProvider && aiKey && aiModel) {
      const savedProvider = localStorage.getItem('ai-provider') || 'openai';
      const savedKey = sessionStorage.getItem('ai-key') || '';
      const savedModel = localStorage.getItem('ai-model') || '';

      aiProvider.value = savedProvider;
      aiKey.value = savedKey;
      aiModel.value = savedModel;

      // Initialize
      updateApiKeyPlaceholder(savedProvider);
      updateProviderLinks(savedProvider);

      // Attempt staged model loading allowing time for apiManager to attach
      if (savedKey) {
        setTimeout(() => tryLoadModels(), 150); // initial attempt
        setTimeout(() => { if (aiModel.disabled) tryLoadModels(); }, 800); // second attempt
      } else {
        resetModelSelect();
      }

      // Listen for late apiManager availability
      document.addEventListener('apiManagerReady', () => {
        if (savedKey && aiModel.disabled) {
          apiManagerRetryCount = 0;
          tryLoadModels();
        }
      });

      // Event listeners
      let keyInputTimeout;

      aiProvider.addEventListener('change', function () {
        const provider = this.value;
        localStorage.setItem('ai-provider', provider);
        updateApiKeyPlaceholder(provider);
        updateProviderLinks(provider);

        if (window.apiManager) window.apiManager.setProvider(provider);

        resetModelSelect();
        if (aiKey.value.trim()) {
          apiManagerRetryCount = 0;
          setTimeout(tryLoadModels, 120);
        }
      });

      aiKey.addEventListener('input', function () {
        const key = this.value;
        sessionStorage.setItem('ai-key', key);

        if (window.apiManager) window.apiManager.setApiKey(key);

        clearTimeout(keyInputTimeout);
        keyInputTimeout = setTimeout(() => {
          if (key.trim()) {
            apiManagerRetryCount = 0;
            tryLoadModels();
          } else {
            resetModelSelect();
          }
        }, 400);
      });

      aiModel.addEventListener('change', function () {
        const model = this.value;
        localStorage.setItem('ai-model', model);

        if (window.apiManager) window.apiManager.setModel(model);
      });
    }

    // Update active navigation links
    function updateActiveLinks() {
      const navLinks = document.querySelectorAll('.nav-link');
      const currentPath = window.location.pathname;

      navLinks.forEach(link => {
        link.classList.remove('active');
        const href = link.getAttribute('href');

        if (href === currentPath ||
          (href !== '/ai-tools/' && currentPath.startsWith(href))) {
          link.classList.add('active');
        }
      });
    }

    // Initialize active links
    updateActiveLinks();

    // Handle category toggle functionality
    const categoryToggles = document.querySelectorAll('.category-toggle');

    categoryToggles.forEach(toggle => {
      toggle.addEventListener('change', function () {
        const icon = this.nextElementSibling.querySelector('.toggle-icon');
        if (icon) {
          icon.textContent = this.checked ? '‚àí' : '+';
        }
      });
    });

    // Handle category title clicks (more reliable than label clicking)
    const categoryTitles = document.querySelectorAll('.category-title');

    categoryTitles.forEach(title => {
      title.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const toggle = this.previousElementSibling;
        if (toggle && toggle.classList.contains('category-toggle')) {
          toggle.checked = !toggle.checked;

          // Trigger change event manually
          const event = new Event('change');
          toggle.dispatchEvent(event);

          const icon = this.querySelector('.toggle-icon');
          if (icon) {
            icon.textContent = toggle.checked ? '‚àí' : '+';
          }
        }
      });
    });

    // Initialize icons on page load
    categoryToggles.forEach(toggle => {
      const icon = toggle.nextElementSibling.querySelector('.toggle-icon');
      if (icon) {
        icon.textContent = toggle.checked ? '‚àí' : '+';
      }
    });
  });
</script>

<style>
  /* Flashy 3D Button Animation */
  @keyframes pulse-glow {

    0%,
    100% {
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4),
        inset 0 -3px 8px rgba(0, 0, 0, 0.2),
        inset 0 3px 8px rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    50% {
      box-shadow: 0 6px 25px rgba(255, 107, 53, 0.8),
        0 0 30px rgba(255, 107, 53, 0.6),
        inset 0 -3px 8px rgba(0, 0, 0, 0.2),
        inset 0 3px 8px rgba(255, 255, 255, 0.3);
      transform: translateY(-3px);
    }
  }

  .ai-tools-flashy-btn:hover {
    transform: translateY(-4px) scale(1.05) !important;
    box-shadow: 0 8px 30px rgba(255, 107, 53, 0.9),
      0 0 40px rgba(255, 107, 53, 0.7),
      inset 0 -3px 8px rgba(0, 0, 0, 0.2),
      inset 0 3px 8px rgba(255, 255, 255, 0.4) !important;
    animation: none !important;
  }

  .ai-tools-flashy-btn:active {
    transform: translateY(-1px) scale(0.98) !important;
    box-shadow: 0 2px 10px rgba(255, 107, 53, 0.6),
      inset 0 -1px 4px rgba(0, 0, 0, 0.3),
      inset 0 1px 4px rgba(255, 255, 255, 0.2) !important;
  }
</style>